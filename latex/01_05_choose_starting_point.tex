% copyright 2020 Edmundo Carmona Antoranz
% Released under the terms of Creative Commons Attribution-ShareAlike 4.0 International Public License

\section{Selecciona tu punto de partida}

\subsection{Ejemplo 5}
\label{example_05}

Desde el \hyperref[git_repo]{repo de git}, hagan checkout {\bf 4a12f89865} y mezclen {\bf aaf633c2ad}.
\footnote{Estos son los padres de la revisión {\bf f4f8dfe127}}.

\begin{lstlisting}[style=c_style,
	basicstyle=\tiny,
	firstnumber=686,
	caption={\bf Ejemplo 5} - {\bf CB} en {\bf builtin/gc.c}]
<<<<<<< HEAD
if (gc_write_commit_graph &&
    write_commit_graph_reachable(get_object_directory(),
				 !quiet && !daemonized ? COMMIT_GRAPH_WRITE_PROGRESS : 0,
				 NULL))
	return 1;
||||||| 9c9b961d7e
if (gc_write_commit_graph &&
    write_commit_graph_reachable(get_object_directory(),
				 !quiet && !daemonized ? COMMIT_GRAPH_PROGRESS : 0,
				 NULL))
	return 1;
=======
prepare_repo_settings(the_repository);
if (the_repository->settings.gc_write_commit_graph == 1)
	write_commit_graph_reachable(get_object_directory(),
				     !quiet && !daemonized ? COMMIT_GRAPH_PROGRESS : 0,
				     NULL);
>>>>>>> aaf633c2ad
\end{lstlisting}\footnote{Todos los {\it snippets} de este capítulo estarán desplazados un {\it tabulador} hacia
la izquierda por cuestiones de espacio pero si trabajan sobre las revisiones reales del repositorio, verán el código
en su formato original}

Siguiendo la misma técnica que hemos venido utilizando, comencemos a trabajar desde el {\bf UB} (con los
marcadores, por claridad):

\begin{lstlisting}[style=c_style,
	basicstyle=\tiny,
	firstnumber=686,
	caption={\bf Ejemplo 5} - {\bf UB} en {\bf CB}]
<<<<<<< HEAD
if (gc_write_commit_graph &&
    write_commit_graph_reachable(get_object_directory(),
				 !quiet && !daemonized ? COMMIT_GRAPH_WRITE_PROGRESS : 0,
				 NULL))
	return 1;
||||||| 9c9b961d7e
\end{lstlisting}

Veamos el {\bf dML}:

\begin{lstlisting}[style=c_style,
	basicstyle=\tiny,
	firstnumber=692,
	caption={\bf Ejemplo 5} - {\bf MB} y {\bf LB} en {\bf CB}]
||||||| 9c9b961d7e
if (gc_write_commit_graph &&
    write_commit_graph_reachable(get_object_directory(),
				 !quiet && !daemonized ? COMMIT_GRAPH_PROGRESS : 0,
				 NULL))
	return 1;
=======
prepare_repo_settings(the_repository);
if (the_repository->settings.gc_write_commit_graph == 1)
	write_commit_graph_reachable(get_object_directory(),
				     !quiet && !daemonized ? COMMIT_GRAPH_PROGRESS : 0,
				     NULL);
>>>>>>> aaf633c2ad
\end{lstlisting}

{\bf dML}: Una llamada a {\bf prepare\_repo\_settings()} fue agregada (línea 699), el condicional fue modificado tal que modified
so that la variable {\it standalone} {\bf gc\_write\_commit\_graph} de la línea 694 ahora es parte de un {\bf struct * } en
la línea 700. La llamada a {\bf write\_commit\_graph\_reachable()} originalmente usada como parte del condidional (línea 694)
ahora es parte de la sección{\bf if-true} del condicional (línea 701) así que se ajustó el formato y finalmente el {\bf return}
fue removido (originalmente en la línea 697).

Repliquemos todos esos cambios en el {\bf UB}.

\begin{lstlisting}[style=c_style,
	basicstyle=\tiny,
	firstnumber=686,
	caption={\bf example 5} - Paso 1 - insertar llamada]
<<<<<<< HEAD
prepare_repo_settings(the_repository);
if (gc_write_commit_graph &&
    write_commit_graph_reachable(get_object_directory(),
				 !quiet && !daemonized ? COMMIT_GRAPH_WRITE_PROGRESS : 0,
				 NULL))
	return 1;
||||||| 9c9b961d7e
\end{lstlisting}

\begin{lstlisting}[style=c_style,
	basicstyle=\tiny,
	firstnumber=686,
	caption={\bf Ejemplo 5} - Paso 2 - ajustar condicional]
<<<<<<< HEAD
prepare_repo_settings(the_repository);
if (the_repository->settings.gc_write_commit_graph == 1)
    write_commit_graph_reachable(get_object_directory(),
				 !quiet && !daemonized ? COMMIT_GRAPH_WRITE_PROGRESS : 0,
				 NULL);
	return 1;
||||||| 9c9b961d7e
\end{lstlisting}

\begin{lstlisting}[style=c_style,
	basicstyle=\tiny,
	firstnumber=686,
	caption={\bf Ejemplo 5} - Paso 3 - ajustar formato]
<<<<<<< HEAD
prepare_repo_settings(the_repository);
if (the_repository->settings.gc_write_commit_graph == 1)
	write_commit_graph_reachable(get_object_directory(),
				     !quiet && !daemonized ? COMMIT_GRAPH_WRITE_PROGRESS : 0,
				     NULL);
	return 1;
||||||| 9c9b961d7e
\end{lstlisting}

\begin{lstlisting}[style=c_style,
	basicstyle=\tiny,
	firstnumber=686,
	caption={\bf Ejemplo 5} - Paso 4 - Remover {\bf return}]
<<<<<<< HEAD
prepare_repo_settings(the_repository);
if (the_repository->settings.gc_write_commit_graph == 1)
	write_commit_graph_reachable(get_object_directory(),
				     !quiet && !daemonized ? COMMIT_GRAPH_WRITE_PROGRESS : 0,
				     NULL);
||||||| 9c9b961d7e
\end{lstlisting}

Final result:
\begin{lstlisting}[style=c_style,
	basicstyle=\tiny,
	firstnumber=681,
	caption={\bf Ejemplo 5} - resultado final]
if (pack_garbage.nr > 0) {
	close_object_store(the_repository->objects);
	clean_pack_garbage();
}

prepare_repo_settings(the_repository);
if (the_repository->settings.gc_write_commit_graph == 1)
	write_commit_graph_reachable(get_object_directory(),
				     !quiet && !daemonized ? COMMIT_GRAPH_WRITE_PROGRESS : 0,
				     NULL);

if (auto_gc && too_many_loose_objects())
\end{lstlisting}

\subsection{Ejemplo 5... desde el LB}

En total, se hicieron 5 modificaciones sobre el {\bf UB} para resolver el conflicto. Ahora bien, no hay ninguna obligación 
de trabajar desde el {\bf UB}. Podemos trabajar desde el {\bf LB}

Comencemos de nuevo:

\begin{lstlisting}[style=c_style,
	basicstyle=\tiny,
	firstnumber=698,
	caption={\bf Ejemplo 5} - {\bf LB} en {\bf CB}]
=======
prepare_repo_settings(the_repository);
if (the_repository->settings.gc_write_commit_graph == 1)
	write_commit_graph_reachable(get_object_directory(),
				     !quiet && !daemonized ? COMMIT_GRAPH_PROGRESS : 0,
				     NULL);
>>>>>>> aaf633c2ad
\end{lstlisting}

Hagamos el análisis del {\bf dMU} en esta oportunidad:

\begin{lstlisting}[style=c_style,
	basicstyle=\tiny,
	firstnumber=686,
	caption={\bf Ejemplo 5} - {\bf UB} y {\bf MB} en {\bf CB}]
<<<<<<< HEAD
if (gc_write_commit_graph &&
    write_commit_graph_reachable(get_object_directory(),
				 !quiet && !daemonized ? COMMIT_GRAPH_WRITE_PROGRESS : 0,
				 NULL))
	return 1;
||||||| 9c9b961d7e
if (gc_write_commit_graph &&
    write_commit_graph_reachable(get_object_directory(),
				 !quiet && !daemonized ? COMMIT_GRAPH_PROGRESS : 0,
				 NULL))
	return 1;
=======
\end{lstlisting}

{\bf dMU}: El {\bf COMMIT\_GRAPH\_PROGRESS} original en la línea 695 ahora es {\bf COMMIT\_GRAPH\_WRITE\_PROGRESS} en la línea 689.
\footnote{Recuerden que esto es {\bf dMU} así que el analisis se hace {\it desde} el {\bf MB} {\it hacia} el {\bf UB}, así que el
análisis se hace {\bf subiendo}!}

Repliquemos los cambios en el {\bf LB}:

\begin{lstlisting}[style=c_style,
	basicstyle=\tiny,
	firstnumber=698,
	caption={\bf Ejemplo 5} - Paso 1]
=======
prepare_repo_settings(the_repository);
if (the_repository->settings.gc_write_commit_graph == 1)
	write_commit_graph_reachable(get_object_directory(),
				     !quiet && !daemonized ? COMMIT_GRAPH_WRITE_PROGRESS : 0,
				     NULL);
>>>>>>> aaf633c2ad
\end{lstlisting}

Y eso es todo! Resultado final:
\begin{lstlisting}[style=c_style,
	basicstyle=\tiny,
	firstnumber=681,
	caption={\bf Ejemplo 5} - Resultado final]
if (pack_garbage.nr > 0) {
	close_object_store(the_repository->objects);
	clean_pack_garbage();
}

prepare_repo_settings(the_repository);
if (the_repository->settings.gc_write_commit_graph == 1)
	write_commit_graph_reachable(get_object_directory(),
				     !quiet && !daemonized ? COMMIT_GRAPH_WRITE_PROGRESS : 0,
				     NULL);

if (auto_gc && too_many_loose_objects())
\end{lstlisting}

Que es exactamente como la resolución que intentamos previamente. La única diferencia es que tuvimos que trabajar {\bf menos}
porque comenzamos desde el bloque que era más diferente con respecto al {\bf MB}. Menos cambios que detectar y ejecutar... y
por ende menos oportunidades de cometer un error.

