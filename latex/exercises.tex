% copyright 2020 Edmundo Carmona Antoranz
% Released under the terms of Creative Commons Attribution-ShareAlike 4.0 International Public License

\chapter{Ejercicios}

\section{Ejercicio 1}
\label{exercise_01}
\subsection*{Problema}
Tome la rama {\bf exercise1/branchA } del \hyperref[exercises_repo]{\bf repositorio de ejercicios}. Hay una lista
e verbos irregulares en inglés dentro de {\bf irregular.txt} en orden alfabético. Agregue estos dos verbos: {\bf drink} y {\bf know}.
Luego tome {\bf example1/branchB } y agregue estos dos verbos: {\bf lose } y {\bf keep }. Mezcle ambas ramas.

\subsection*{Conflicto}
Se debe ver un conflicto así:
\begin{lstlisting}[style=console_style, numbers=left, caption={\bf Ejercicio 1} - conflicto]
# List of irregular verbs
# simple form<tab>past tense<tab>past participle
catch	caught	caught
draw	drew	drawn
drink	drank	drinken
eat	ate	eaten
fight	fought	fought
fly	flew	flown
grow	grew	grown
hang	hung	hung
<<<<<<< HEAD
know	knew	known
=======
keep	kept	kept
>>>>>>> exercise1/branchB
let	let	let
lose	lost	lost
read	read	read
run	ran	run
sleep	slept	slept
\end{lstlisting}

Puede ser que las secciones del conflicto estén en orden inverso (primero {\bf keep} y luego {\bf know}) si estaban en la rama
{\bf branchB} e intentaron mezclar la rama {\bf branchA}. Fíjense que el conflicto sol se refiere a {\bf keep/know}. Los otros dos verbos,
{\bf drink} y {\bf lose}, se mezclaron correctamente, unque vienen de ramas diferentes.

\subsection*{Resolución}
Dado que los verbos se están agregando en orden alfabético, el archivo resultante se debe ver así:
\begin{lstlisting}[style=console_style, numbers=left, caption={\bf Ejercicio 1} - Resolución]
# List of irregular verbs
# simple form<tab>past tense<tab>past participle
catch	caught	caught
draw	drew	drawn
drink	drank	drinken
eat	ate	eaten
fight	fought	fought
fly	flew	flown
grow	grew	grown
hang	hung	hung
keep	kept	kept
know	knew	known
let	let	let
lose	lost	lost
read	read	read
run	ran	run
sleep	slept	slept
\end{lstlisting}
Dado que la lista es alfabética, se debe colocar {\bf keep} seguido de {\bf know}.


\section{Ejercicio 2}
\label{exercise_02}
Del \hyperref[exercises_repo]{\bf repositorio de ejercicios}, mezcle las ramas {\bf exercise2/branchA} y {\bf exercise2/branchB}.

\subsection*{Conflicto}
\begin{lstlisting}[style=python_style, caption={\bf Ejercicio 2} - conflicto]
#!/usr/bin/python

import sys

colors = {"black": "black mirror",
          "white":  "white noise",
          "blue": "blue sky"}

def getPhrase(color):
<<<<<<< HEAD
    phrase = colors[color.lower()]
=======
    if color not in colors:
        sys.stderr.write("Got no phrase for color %s\n" % color)
        sys.exit(1)
    phrase = colors[color]
>>>>>>> exercise2/branchB
    return phrase

print(getPhrase(sys.argv[1]))
\end{lstlisting}

\subsection*{Resolution}
La solución correcta debe ser algo así:

\begin{lstlisting}[style=python_style, caption={\bf Ejercicio 2} - resolución]
#!/usr/bin/python

import sys

colors = {"black": "black mirror",
          "white":  "white noise",
          "blue": "blue sky"}

def getPhrase(color):
    if color.lower() not in colors:
        sys.stderr.write("Got no phrase for color %s\n" % color)
        sys.exit(1)
    phrase = colors[color.lower()]
    return phrase

print(getPhrase(sys.argv[1]))
\end{lstlisting}

Si no colocaron la llamada a {\bf lower()} en la línea 10, está bien... por el momento. Explicaré la lógica
para agregar la llamada más adelante. Pudieron haber hecho otras cosas como guardar el color para que quede en minúsculas antes
de entrar al {\bf if} de la línea 10 pero veremos las cosas que se podría/debería hacer a medida que avanzamos en otros tópicos.
Puedo asegurarles algo, esto es solo un abrebocas de lo que es un conflicto.

\section{Ejercicio 3}
\label{exercise_03}
\subsubsection{Ejercicio 3}
Del \hyperref[git_repo]{repo de git}, hacer checkout de la revisión {\bf fe870600fe} y mezclar {\bf 1bdca81641}
\footnote{Estos son los padres de la revisión {\bf f8cb64e3d4}}. Resuelvan ambos conflictos (hay 2 archivos con conflctos,
un conflicto en cada archivo).

\subsection*{Conflicto en path.c}
\begin{lstlisting}[style=c_style, firstnumber=852, caption={\bf Ejercicio 3} - conflicto en {\bf path.c}]
	if (is_git_directory(".")) {
<<<<<<< HEAD
		set_git_dir(".", 0);
		check_repository_format();
||||||| 51ebf55b93
		set_git_dir(".");
		check_repository_format();
=======
		set_git_dir(".");
		check_repository_format(NULL);
>>>>>>> 1bdca81641
		return path;
	}
\end{lstlisting}
Creo que noes muy difícil entender lo que sucedió en cada rama. En {\bf HEAD} la llamada a {\bf set\_git\_dir()}
toma un segundo parámetro en la línea 854. En {\bf la otra rama}, la llamada a {\bf check\_repository\_format()} tiene un
nuevo parámetro {\bf NULL} en la línea 861. Esto apunta a tener esto como resolución del conflicto:

\begin{lstlisting}[style=c_style, firstnumber=852, caption={\bf Ejercicio 3} - resolución del conflicto en {\bf path.c}]
	if (is_git_directory(".")) {
		set_git_dir(".", 0);
		check_repository_format(NULL);
		return path;
	}
\end{lstlisting}

\subsection*{Conflicto en builtin/pack-objects.c}
\begin{lstlisting}[style=c_style, basicstyle=\small, firstnumber=880, caption={\bf Ejercicio 3} - conflicto en {\bf builtin/pack-objects.c}]
	len = encode_in_pack_object_header(header, sizeof(header),
					   OBJ_REF_DELTA, size);
	hashwrite(out, header, len);
<<<<<<< HEAD
	hashwrite(out, base_oid.hash, 20);
||||||| 51ebf55b93
	hashwrite(out, base_sha1, 20);
=======
	hashwrite(out, base_sha1, the_hash_algo->rawsz);
>>>>>>> 1bdca81641
	copy_pack_data(out, reuse_packfile, w_curs, cur, next - cur);
	return;
\end{lstlisting}

En este caso, en {\bf HEAD} el {\it segundo parámetro} a la llamada a {\bf hashwrite()} fue cambiado de {\bf base\_sha1} en
la línea 886 a {\bf base\_oid.hash} en la línea 884. En {\bf la otra rama}, el {\it tercer parámetro} a la misma llamada
cambió de {\bf 20} en la línea 886 a {\bf the\_hash\_algo-$>$rawsz} en la línea 888. Esto apunta a esto como resolución:

\begin{lstlisting}[style=c_style, firstnumber=880, basicstyle=\small, caption={\bf Ejercicio 3} - resolución del conflicto en {\bf builtin/pack-objects.c}]
	len = encode_in_pack_object_header(header, sizeof(header),
					   OBJ_REF_DELTA, size);
	hashwrite(out, header, len);
	hashwrite(out, base_oid.hash, the_hash_algo->rawsz);
	copy_pack_data(out, reuse_packfile, w_curs, cur, next - cur);
	return;
\end{lstlisting}

Si comparan con la revisión {\bf f8cb64e3d4}, ne deberían obtener diferencias significativas.

Como ejercicio {\bf adicional},  imaginen lo que tendrían que hacer para resolver esos conflictos si no usaran {\bf diff3}.

\section{Exercise 4 - a git conflict}
\label{exercise_04}
From \hyperref[git_repo]{git's repo}, checkout {\bf d9d65e9f6a} and merge {\bf b57e8119e6}.
\footnote{These are the parents of revision {\bf 01f8d78887}}.

\subsection*{CB in contrib/completion/git-completion.bash}
\begin{lstlisting}[style=c_style,
	basicstyle=firstnumber=2614,
	basicstyle=\tiny,
	caption={\bf Exercise 4} - CB in {\bf contrib/completion/git-completion.bash}]
<<<<<<< HEAD
	local subcommands="add status init deinit update summary foreach sync absorbgitdirs"
||||||| d62dad7a7d
	local subcommands="add status init deinit update summary foreach sync"
=======
	local subcommands="add status init deinit update set-branch summary foreach sync"
>>>>>>> b57e8119e6
\end{lstlisting}

\subsection*{Working from {\bf UB} (keeping markers for clarity)}
\begin{lstlisting}[style=c_style,
	basicstyle=firstnumber=2614,
	basicstyle=\tiny,
	caption={\bf Exercise 4} - UB in {\bf contrib/completion/git-completion.bash}]
<<<<<<< HEAD
	local subcommands="add status init deinit update summary foreach sync absorbgitdirs"
||||||| d62dad7a7d
\end{lstlisting}

\subsection*{Get {\bf dML}}
\begin{lstlisting}[style=c_style,
	basicstyle=firstnumber=2616,
	basicstyle=\tiny,
	caption={\bf Exercise 4} - {\bf MB} and {\bf LB} in {\bf contrib/completion/git-completion.bash}]
||||||| d62dad7a7d
	local subcommands="add status init deinit update summary foreach sync"
=======
	local subcommands="add status init deinit update set-branch summary foreach sync"
>>>>>>> b57e8119e6
\end{lstlisting}

{\bf dML}: {\bf set-branch} is added between {\bf update} and {\bf summary} as a {\bf subcommand}.

\subsection*{Apply {\bf dML} on {\bf UB}}
\begin{lstlisting}[style=c_style,
	basicstyle=firstnumber=2614,
	basicstyle=\tiny,
	caption={\bf Exercise 4} - UB in {\bf contrib/completion/git-completion.bash}]
<<<<<<< HEAD
	local subcommands="add status init deinit update set-branch summary foreach sync absorbgitdirs"
||||||| d62dad7a7d
\end{lstlisting}

\subsection*{Result}
\begin{lstlisting}[style=c_style,
	basicstyle=firstnumber=2610,
	basicstyle=\tiny,
	caption={\bf Exercise 4} - UB in {\bf contrib/completion/git-completion.bash}]
_git_submodule ()
{
	__git_has_doubledash && return

	local subcommands="add status init deinit update set-branch summary foreach sync absorbgitdirs"
	local subcommand="$(__git_find_on_cmdline "$subcommands")"
\end{lstlisting}


\section{Exercise 5 - another git conflict}
\label{exercise_05}
From \hyperref[git_repo]{git's repo}, checkout {\bf cf054f817a} and merge {\bf caf388caa1}.
\footnote{These are the parents of revision {\bf 9b6606f43d}}.

I will let you work on this conflict on your own. There are 5 CBs in 3 files. When you are done, compare
with {\bf 9b6606f43d} and you should get no meaningful differences.

