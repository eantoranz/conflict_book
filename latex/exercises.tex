% copyright 2020 Edmundo Carmona Antoranz
% Released under the terms of Creative Commons Attribution-ShareAlike 4.0 International Public License

\chapter{Exercises}

\section{Exercise 1}
\label{exercise_01}
\subsection*{Problem}
Take branch {\bf exercise1/branchA } from the \hyperref[exercises_repo]{\bf exercises repo}. There is a short list of
irregular verbs inside {\bf irregular.txt} in alphabetical order. Add these two verbs: {\bf drink} and {\bf know}. Then
take branch {\bf example1/branchB } and add these other 2 verbs: {\bf lose } and {\bf keep }. Merge the two branches.

\subsection*{Conflict}
You should see a conflict like this:
\begin{lstlisting}[style=console_style, numbers=left, caption={\bf Exercise 1} - conflict]
# List of irregular verbs
# simple form<tab>past tense<tab>past participle
catch	caught	caught
draw	drew	drawn
drink	drank	drinken
eat	ate	eaten
fight	fought	fought
fly	flew	flown
grow	grew	grown
hang	hung	hung
<<<<<<< HEAD
know	knew	known
=======
keep	kept	kept
>>>>>>> exercise1/branchB
let	let	let
lose	lost	lost
read	read	read
run	ran	run
sleep	slept	slept
\end{lstlisting}

You might have gotten the conflct section branches in reverse order (first {\bf keep}, then {\bf know}) if you were on {\bf branchB} 
and then tried to merge {\bf branchA}. Notice how the conflict is only related to {\bf know/keep}. The other two verbs,
{\bf drink} and {\bf lose}, were merged correctly, even though they come from different branches.

\subsection*{Resolution}
Given that the verbs are ordered alphabetically, the resulting file looks like this:
\begin{lstlisting}[style=console_style, numbers=left, caption={\bf Exercise 1} - Resolution]
# List of irregular verbs
# simple form<tab>past tense<tab>past participle
catch	caught	caught
draw	drew	drawn
drink	drank	drinken
eat	ate	eaten
fight	fought	fought
fly	flew	flown
grow	grew	grown
hang	hung	hung
keep	kept	kept
know	knew	known
let	let	let
lose	lost	lost
read	read	read
run	ran	run
sleep	slept	slept
\end{lstlisting}
Given that the list is sorted alphabetically, {\bf keep} had to be placed before {\bf know}.


\section{Exercise 2}
\label{exercise_02}
From the \hyperref[exercises_repo]{\bf exercises repo}, merge branches {\bf exercise2/branchA} and {\bf exercise2/branchB}.

\subsection*{Conflict}
\begin{lstlisting}[style=python_style, caption={\bf Exercise 2} - conflict]
#!/usr/bin/python

import sys

colors = {"black": "black mirror",
          "white":  "white noise",
          "blue": "blue sky"}

def getPhrase(color):
<<<<<<< HEAD
    phrase = colors[color.lower()]
=======
    if color not in colors:
        sys.stderr.write("Got no phrase for color %s\n" % color)
        sys.exit(1)
    phrase = colors[color]
>>>>>>> exercise2/branchB
    return phrase

print(getPhrase(sys.argv[1]))
\end{lstlisting}

\subsection*{Resolution}
Correct resolution {\bf might} be something like this:

\begin{lstlisting}[style=python_style, caption={\bf Exercise 2} - resolution]
#!/usr/bin/python

import sys

colors = {"black": "black mirror",
          "white":  "white noise",
          "blue": "blue sky"}

def getPhrase(color):
    if color.lower() not in colors:
        sys.stderr.write("Got no phrase for color %s\n" % color)
        sys.exit(1)
    phrase = colors[color.lower()]
    return phrase

print(getPhrase(sys.argv[1]))
\end{lstlisting}

If you didn't use the {\bf lower()} call on line 10, it's ok... for the time being. I will explain the rationale to
add that call later on. You could have done other things like save color to be lowercase before going into the {\bf if} on
line 10 but we will be touching on the things that we could/should do as we go through other topics. Rest assured, this is just a {\bf teaser} of a conflict.

\section{Exercise 3}
\label{exercise_03}
From \hyperref[git_repo]{git's repo}, checkout revision {\bf fe870600fe} and merge {\bf 1bdca81641}
\footnote{These are the parents of revision {\bf f8cb64e3d4}}. Solve both conflicts (there are 2 conflicting files,
one conflict section on each one of the files).

\subsection*{Conflict in path.c}
\begin{lstlisting}[style=c_style, firstnumber=852, caption={\bf Exercise 3} - conflict in {\bf path.c}]
	if (is_git_directory(".")) {
<<<<<<< HEAD
		set_git_dir(".", 0);
		check_repository_format();
||||||| 51ebf55b93
		set_git_dir(".");
		check_repository_format();
=======
		set_git_dir(".");
		check_repository_format(NULL);
>>>>>>> 1bdca81641
		return path;
	}
\end{lstlisting}
I don't think it is too difficult to realize what happened on each branch. On {\bf HEAD} the call to {\bf set\_git\_dir()} got a second
parameter on line 854. On {\bf the other branch}, the call to {\bf check\_repository\_format()} got a new NULL parameter on line 861.
That points to having this as the conflict resolution:

\begin{lstlisting}[style=c_style, firstnumber=852, caption={\bf Exercise 3} - resolution to conflict in {\bf path.c}]
	if (is_git_directory(".")) {
		set_git_dir(".", 0);
		check_repository_format(NULL);
		return path;
	}
\end{lstlisting}

\subsection*{Conflict in builtin/pack-objects.c}
\begin{lstlisting}[style=c_style, basicstyle=\small, firstnumber=880, caption={\bf Exercise 3} - conflict in {\bf builtin/pack-objects.c}]
	len = encode_in_pack_object_header(header, sizeof(header),
					   OBJ_REF_DELTA, size);
	hashwrite(out, header, len);
<<<<<<< HEAD
	hashwrite(out, base_oid.hash, 20);
||||||| 51ebf55b93
	hashwrite(out, base_sha1, 20);
=======
	hashwrite(out, base_sha1, the_hash_algo->rawsz);
>>>>>>> 1bdca81641
	copy_pack_data(out, reuse_packfile, w_curs, cur, next - cur);
	return;
\end{lstlisting}

In this case, on {\bf HEAD} the second parameter to the {\bf hashwrite()} call was changed from {\bf base\_sha1} on
line 886 to {\bf base\_oid.hash} on line 884. On {\bf the ther branch}, the {\it third parameter} to the same call was
changed from {\bf 20} on line 886 to {\bf the\_hash\_algo-$>$rawsz} on line 888. This all points to this as the conflict
resolution:

\begin{lstlisting}[style=c_style, firstnumber=880, basicstyle=\small, caption={\bf Exercise 3} - conflict in {\bf builtin/pack-objects.c}]
	len = encode_in_pack_object_header(header, sizeof(header),
					   OBJ_REF_DELTA, size);
	hashwrite(out, header, len);
	hashwrite(out, base_oid.hash, the_hash_algo->rawsz);
	copy_pack_data(out, reuse_packfile, w_curs, cur, next - cur);
	return;
\end{lstlisting}

If you compare with revision {\bf f8cb64e3d4}, you should get no meaningful difference.

As an {\bf additional} exercise, imagine what the task would have been {\it if} {\bf diff3} had not been used.

\section{Exercise 4 - a git conflict}
\label{exercise_04}
From \hyperref[git_repo]{git's repo}, checkout {\bf d9d65e9f6a} and merge {\bf b57e8119e6}.
\footnote{These are the parents of revision {\bf 01f8d78887}}.

\subsection*{CB in contrib/completion/git-completion.bash}
\begin{lstlisting}[style=c_style,
	basicstyle=firstnumber=2614,
	basicstyle=\tiny,
	caption={\bf Exercise 4} - CB in {\bf contrib/completion/git-completion.bash}]
<<<<<<< HEAD
	local subcommands="add status init deinit update summary foreach sync absorbgitdirs"
||||||| d62dad7a7d
	local subcommands="add status init deinit update summary foreach sync"
=======
	local subcommands="add status init deinit update set-branch summary foreach sync"
>>>>>>> b57e8119e6
\end{lstlisting}

\subsection*{Working from {\bf UB} (keeping markers for clarity)}
\begin{lstlisting}[style=c_style,
	basicstyle=firstnumber=2614,
	basicstyle=\tiny,
	caption={\bf Exercise 4} - UB in {\bf contrib/completion/git-completion.bash}]
<<<<<<< HEAD
	local subcommands="add status init deinit update summary foreach sync absorbgitdirs"
||||||| d62dad7a7d
\end{lstlisting}

\subsection*{Get {\bf dML}}
\begin{lstlisting}[style=c_style,
	basicstyle=firstnumber=2616,
	basicstyle=\tiny,
	caption={\bf Exercise 4} - {\bf MB} and {\bf LB} in {\bf contrib/completion/git-completion.bash}]
||||||| d62dad7a7d
	local subcommands="add status init deinit update summary foreach sync"
=======
	local subcommands="add status init deinit update set-branch summary foreach sync"
>>>>>>> b57e8119e6
\end{lstlisting}

{\bf dML}: {\bf set-branch} is added between {\bf update} and {\bf summary} as a {\bf subcommand}.

\subsection*{Apply {\bf dML} on {\bf UB}}
\begin{lstlisting}[style=c_style,
	basicstyle=firstnumber=2614,
	basicstyle=\tiny,
	caption={\bf Exercise 4} - UB in {\bf contrib/completion/git-completion.bash}]
<<<<<<< HEAD
	local subcommands="add status init deinit update set-branch summary foreach sync absorbgitdirs"
||||||| d62dad7a7d
\end{lstlisting}

\subsection*{Result}
\begin{lstlisting}[style=c_style,
	basicstyle=firstnumber=2610,
	basicstyle=\tiny,
	caption={\bf Exercise 4} - UB in {\bf contrib/completion/git-completion.bash}]
_git_submodule ()
{
	__git_has_doubledash && return

	local subcommands="add status init deinit update set-branch summary foreach sync absorbgitdirs"
	local subcommand="$(__git_find_on_cmdline "$subcommands")"
\end{lstlisting}


\section{Exercise 5 - another git conflict}
\label{exercise_05}
From \hyperref[git_repo]{git's repo}, checkout {\bf cf054f817a} and merge {\bf caf388caa1}.
\footnote{These are the parents of revision {\bf 9b6606f43d}}.

I will let you work on this conflict on your own. There are 5 CBs in 3 files. When you are done, compare
with {\bf 9b6606f43d} and you should get no meaningful differences.

